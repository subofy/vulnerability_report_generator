import zipfile
import glob
import io
import os
import re
import xlrd
import xlsxwriter

dirname = glob.glob('*_xls')[0]
xlsfilenames = glob.glob(dirname + '/*.xls')
reportfile = xlsxwriter.Workbook('报告.xlsx')
merge_format = reportfile.add_format({
    'align':'center',
    'valign':'vcenter',
    'border': 1})
text_format = reportfile.add_format({
    'text_wrap': True,
    'border': 1
})
worksheet = reportfile.add_worksheet()

total_vul = 1
worksheet.write(0, 0, '影响IP', merge_format)
worksheet.set_column(0, 0, 15) #设置行的宽度
worksheet.write(0, 1, '漏洞名称', merge_format)
worksheet.set_column(1, 1, 25)
worksheet.write(0, 2, '危险程度', merge_format)
worksheet.set_column(2, 2, 15)
for xlsfile in xlsfilenames:
    if not xlsfile.endswith('index.xls'):
        sheet = xlrd.open_workbook(xlsfile).sheet_by_name('远程漏洞') #打开名为漏洞信息的sheet
        old_total_vul = total_vul
        ip = (os.path.splitext(os.path.basename(xlsfile)))[0]
        vul_number = sheet.nrows - 2
        for i in range(vul_number):
            ser = (re.findall(r"\[(.*)\]", sheet.cell_value(i + 2, 5)))[0]
            if (ser == '高'):
                worksheet.write(total_vul, 1, sheet.cell_value(i + 2, 3), text_format)
                worksheet.write(total_vul, 2, '高危', merge_format)
                total_vul += 1
                
        for i in range(vul_number):
            ser = (re.findall(r"\[(.*)\]", sheet.cell_value(i + 2, 5)))[0]
            if (ser == '中'):
                worksheet.write(total_vul, 1, sheet.cell_value(i + 2, 3), text_format)
                worksheet.write(total_vul, 2, '中危', merge_format)
                total_vul += 1
        for i in range(vul_number):
            ser = (re.findall(r"\[(.*)\]", sheet.cell_value(i + 2, 5)))[0]
            if (ser == '低'):
                worksheet.write(total_vul, 1, sheet.cell_value(i + 2, 3), text_format)
                worksheet.write(total_vul, 2, '低危', merge_format)
                total_vul += 1
        vul_number = total_vul - old_total_vul
        if vul_number > 1:
            worksheet.merge_range(old_total_vul, 0, total_vul - 1, 0,
                ip,
                merge_format)
        elif vul_number == 1:
            worksheet.write(old_total_vul, 0, ip, merge_format)
reportfile.close()